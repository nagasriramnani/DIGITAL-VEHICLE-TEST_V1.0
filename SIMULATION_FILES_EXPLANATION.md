# üìÅ Simulation Files Explanation - What's in `sim_output/`?

## üéØ Overview

The `sim_output/` directory contains **executable simulation scripts** generated by VTA from your test scenarios. These files convert abstract test descriptions into runnable simulations for CARLA and SUMO platforms.

---

## üìÇ Directory Structure

```
sim_output/
‚îú‚îÄ‚îÄ carla/                    # CARLA simulation files
‚îÇ   ‚îú‚îÄ‚îÄ dfaf323f-db0f-4014-93b3-a544618c798d.py
‚îÇ   ‚îú‚îÄ‚îÄ ef6c0832-ebd7-41cb-861d-b2c30ca3655a.py
‚îÇ   ‚îî‚îÄ‚îÄ TEST-001.py
‚îÇ
‚îî‚îÄ‚îÄ sumo/                     # SUMO simulation files
    ‚îú‚îÄ‚îÄ TEST-001.sumocfg      # Main SUMO configuration
    ‚îú‚îÄ‚îÄ TEST-001.rou.xml      # Vehicle routes
    ‚îî‚îÄ‚îÄ TEST-001.vtype.xml    # Vehicle type definitions
```

---

## üîÑ How Files Are Generated

### Generation Process

```
VTA Test Scenario (JSON)
    ‚Üì
Scenario Converter
    ‚îú‚îÄ‚îÄ Extract vehicle configuration
    ‚îú‚îÄ‚îÄ Extract environmental conditions
    ‚îú‚îÄ‚îÄ Extract test parameters
    ‚îî‚îÄ‚îÄ Map to simulation format
    ‚Üì
Simulation Exporter
    ‚îú‚îÄ‚îÄ CARLA: Generate Python script
    ‚îî‚îÄ‚îÄ SUMO: Generate XML files
    ‚Üì
sim_output/ Directory
```

### Example: From Test Scenario to Simulation

**Input (VTA Test Scenario):**
```json
{
    "scenario_id": "dfaf323f-db0f-4014-93b3-a544618c798d",
    "test_name": "Leaf_Thermal_Performance_Under_Load_Battery",
    "vehicle_model": "Leaf",
    "platform": "EV",
    "target_components": ["High_Voltage_Battery"],
    "estimated_duration_hours": 8.05,
    "test_type": "performance"
}
```

**Output (CARLA Python Script):**
```python
# Generated Python script that:
# - Connects to CARLA
# - Spawns Tesla Model 3 (representing EV)
# - Configures weather
# - Runs for 28980 seconds
# - Logs vehicle state
```

---

## üöó CARLA Simulation Files (`.py`)

### What Are They?

**CARLA Python scripts** are executable Python programs that:
- Connect to CARLA simulator
- Spawn vehicles in the 3D environment
- Configure weather and environmental conditions
- Run the simulation for the specified duration
- Collect and log vehicle data

### File Structure Explained

Let's break down `dfaf323f-db0f-4014-93b3-a544618c798d.py`:

#### 1. **Header & Imports**
```python
#!/usr/bin/env python3
"""
CARLA Simulation Script: Leaf_Thermal_Performance_Under_Load_Battery
Generated from VTA Test Scenario: dfaf323f-db0f-4014-93b3-a544618c798d

Description: Validate Battery performance characteristics for Leaf under specified conditions
"""

import carla      # CARLA Python API
import random    # For random vehicle selection
import time      # For timing
import math      # For calculations
```

#### 2. **Connection Setup**
```python
# Connect to CARLA server running on localhost:2000
client = carla.Client('localhost', 2000)
client.set_timeout(10.0)  # 10 second timeout

# Get the simulation world
world = client.get_world()
```

**What it does:**
- Connects to CARLA simulator
- Must have CARLA server running first
- Gets access to the 3D simulation environment

#### 3. **Weather Configuration**
```python
weather = carla.WeatherParameters(
    cloudiness=10.0,           # 10% cloud cover (clear sky)
    precipitation=0.0,         # No rain
    precipitation_deposits=0.0, # No water on road
    wind_intensity=5.0,        # Light wind (5 m/s)
    sun_azimuth_angle=180.0,    # Sun direction
    sun_altitude_angle=45.0,    # Sun height (45¬∞ = afternoon)
    fog_density=0.0,           # No fog
    fog_distance=0.0,
    wetness=0.0                # Dry road
)
world.set_weather(weather)
```

**What it does:**
- Sets environmental conditions
- Affects vehicle physics and visibility
- Matches test requirements (e.g., thermal tests need specific temperatures)

#### 4. **Vehicle Spawning**
```python
# Get available vehicle blueprints
blueprint_library = world.get_blueprint_library()

# Select vehicle model (Tesla Model 3 represents EV)
ego_bp = blueprint_library.filter('vehicle.tesla.model3')[0]

# Get spawn points (locations where vehicles can appear)
spawn_points = world.get_map().get_spawn_points()

# Spawn the ego vehicle (test vehicle)
ego_vehicle = world.spawn_actor(ego_bp, spawn_points[0])
```

**What it does:**
- Creates the test vehicle in the simulation
- Uses Tesla Model 3 as a proxy for EV (like Nissan Leaf)
- Places it at a spawn point in the map

#### 5. **Physics Configuration**
```python
# Configure physics for EV platform
if "EV" == "EV":
    physics_control = ego_vehicle.get_physics_control()
    physics_control.mass = 1800.0  # Vehicle mass in kg
    ego_vehicle.apply_physics_control(physics_control)
```

**What it does:**
- Sets vehicle mass (important for physics calculations)
- EV vehicles have different mass than ICE vehicles
- Affects acceleration, braking, and handling

#### 6. **Traffic Vehicles (Optional)**
```python
traffic_vehicles = []
vehicle_bps = blueprint_library.filter('vehicle.*')

for i in range(0):  # 0 = no traffic vehicles
    if i + 1 < len(spawn_points):
        bp = random.choice(vehicle_bps)
        vehicle = world.try_spawn_actor(bp, spawn_points[i + 1])
        if vehicle:
            traffic_vehicles.append(vehicle)
            vehicle.set_autopilot(True)  # Enable AI driving
```

**What it does:**
- Spawns additional vehicles for traffic simulation
- In this case: `range(0)` = no traffic (isolated test)
- Can be increased for traffic scenarios

#### 7. **Autopilot Activation**
```python
# Enable autopilot for ego vehicle
ego_vehicle.set_autopilot(True)
```

**What it does:**
- Enables CARLA's built-in AI driver
- Vehicle drives autonomously
- Follows traffic rules and navigates

#### 8. **Simulation Loop**
```python
# Run simulation for specified duration
duration = 28980.34918689129  # seconds (‚âà 8 hours)
start_time = time.time()

while time.time() - start_time < duration:
    # Get vehicle state
    transform = ego_vehicle.get_transform()  # Position & rotation
    velocity = ego_vehicle.get_velocity()    # Speed vector
    
    # Calculate speed in km/h
    speed_kmh = 3.6 * math.sqrt(velocity.x**2 + velocity.y**2 + velocity.z**2)
    
    # Log data every second
    print(f"Time: {time.time() - start_time:.1f}s | "
          f"Position: ({transform.location.x:.1f}, {transform.location.y:.1f}) | "
          f"Speed: {speed_kmh:.1f} km/h")
    
    time.sleep(1.0)  # Wait 1 second
```

**What it does:**
- Runs simulation for the test duration
- Collects vehicle state data every second
- Logs: time, position (x, y), speed
- Can be extended to collect more data (temperature, battery, etc.)

#### 9. **Cleanup**
```python
# Destroy vehicles
ego_vehicle.destroy()
for vehicle in traffic_vehicles:
    vehicle.destroy()

print("Actors cleaned up")
```

**What it does:**
- Removes vehicles from simulation
- Frees resources
- Prepares for next simulation

---

## üö¶ SUMO Simulation Files

### What Are They?

**SUMO XML files** configure traffic simulations:
- **`.sumocfg`**: Main configuration file
- **`.rou.xml`**: Vehicle routes and traffic
- **`.vtype.xml`**: Vehicle type definitions

### File Structure

#### 1. **TEST-001.sumocfg** (Main Config)
```xml
<configuration>
    <input>
        <net-file value="network.net.xml"/>
        <route-files value="TEST-001.rou.xml"/>
        <additional-files value="TEST-001.vtype.xml"/>
    </input>
    <time>
        <begin value="0"/>
        <end value="7200"/>  <!-- 2 hours -->
    </time>
</configuration>
```

**What it does:**
- Links all SUMO files together
- Sets simulation duration
- Configures network and routes

#### 2. **TEST-001.rou.xml** (Routes)
```xml
<routes>
    <vehicle id="ego" type="ev_vehicle" route="route0" depart="0"/>
    <route id="route0" edges="edge1 edge2 edge3"/>
</routes>
```

**What it does:**
- Defines vehicle routes
- Specifies when vehicles appear
- Sets traffic flow

#### 3. **TEST-001.vtype.xml** (Vehicle Types)
```xml
<vType id="ev_vehicle" 
       accel="2.0" 
       decel="4.5" 
       maxSpeed="50.0"
       length="4.5"
       width="1.8"/>
```

**What it does:**
- Defines vehicle characteristics
- Sets acceleration, max speed, dimensions
- Matches EV/HEV/ICE specifications

---

## üîç What Data Is Extracted from VTA Scenarios?

### From VTA Test Scenario ‚Üí Simulation Parameters

| VTA Field | CARLA/SUMO Parameter | Example |
|-----------|---------------------|---------|
| `vehicle_model` | Vehicle blueprint/model | "Leaf" ‚Üí "vehicle.tesla.model3" |
| `platform` | Physics configuration | "EV" ‚Üí mass=1800kg, EV physics |
| `estimated_duration_hours` | Simulation duration | 8.05 hours ‚Üí 28980 seconds |
| `test_type` | Test configuration | "performance" ‚Üí specific maneuvers |
| `target_components` | Vehicle specs | "Battery" ‚Üí battery capacity, mass |
| `environmental_conditions` | Weather parameters | Temperature ‚Üí sun angle, cloudiness |

---

## üìä Example: Your Simulation File Breakdown

### File: `dfaf323f-db0f-4014-93b3-a544618c798d.py`

**Original Test:**
- **Name**: Leaf_Thermal_Performance_Under_Load_Battery
- **Component**: High_Voltage_Battery
- **Platform**: EV
- **Duration**: 8.05 hours

**Generated Simulation:**
```python
# Vehicle: Tesla Model 3 (represents EV like Leaf)
ego_bp = blueprint_library.filter('vehicle.tesla.model3')[0]

# Physics: EV configuration
physics_control.mass = 1800.0  # kg (typical EV mass)

# Duration: Converted from hours to seconds
duration = 28980.34918689129  # 8.05 hours √ó 3600

# Weather: Clear conditions (for thermal testing)
weather = carla.WeatherParameters(
    cloudiness=10.0,      # Clear sky
    sun_altitude_angle=45.0  # Afternoon sun (affects temperature)
)

# Traffic: None (isolated test)
for i in range(0):  # No traffic vehicles
```

**What This Simulation Tests:**
- Battery thermal performance under load
- Vehicle behavior over 8 hours
- Temperature effects on battery
- Long-duration performance

---

## üéÆ How to Use These Files

### CARLA Files

1. **Start CARLA server:**
   ```bash
   C:\CARLA_0.9.16\CarlaUE4.exe -carla-rpc-port=2000
   ```

2. **Run simulation:**
   ```bash
   python sim_output/carla/dfaf323f-db0f-4014-93b3-a544618c798d.py
   ```

3. **Watch:**
   - CARLA window shows 3D simulation
   - Terminal shows logged data

### SUMO Files

1. **Start SUMO:**
   ```bash
   sumo-gui -c sim_output/sumo/TEST-001.sumocfg
   ```

2. **Or headless:**
   ```bash
   sumo -c sim_output/sumo/TEST-001.sumocfg
   ```

---

## üîß Customization Options

### Modify Simulation Duration

```python
# Change duration (in seconds)
duration = 3600  # 1 hour instead of 8 hours
```

### Add Traffic Vehicles

```python
# Spawn 10 traffic vehicles
for i in range(10):  # Changed from 0 to 10
    # ... spawn code
```

### Change Weather

```python
# Rainy weather
weather = carla.WeatherParameters(
    cloudiness=80.0,
    precipitation=50.0,  # Heavy rain
    precipitation_deposits=50.0
)
```

### Change Vehicle Model

```python
# Use different vehicle
ego_bp = blueprint_library.filter('vehicle.audi.a2')[0]
# or
ego_bp = blueprint_library.filter('vehicle.nissan.patrol')[0]
```

### Add Data Collection

```python
# Save data to file
import json

data = []
while time.time() - start_time < duration:
    # ... collect data ...
    data.append({
        'time': time.time() - start_time,
        'position': [transform.location.x, transform.location.y],
        'speed': speed_kmh
    })

# Save to JSON
with open('simulation_data.json', 'w') as f:
    json.dump(data, f, indent=2)
```

---

## üìà What Data Is Collected?

### Current Implementation

The generated scripts collect:
- **Time**: Elapsed simulation time
- **Position**: X, Y coordinates
- **Speed**: Vehicle speed in km/h

### Can Be Extended To Collect

- **Temperature**: Battery, motor, ambient
- **Energy**: Battery state of charge, consumption
- **Acceleration**: Longitudinal and lateral
- **Steering**: Steering angle
- **Braking**: Brake pressure
- **GPS**: Latitude, longitude
- **Sensors**: Camera, LiDAR, radar data

---

## üîÑ Generation Process Details

### Step 1: VTA Test Scenario

```json
{
    "scenario_id": "dfaf323f-db0f-4014-93b3-a544618c798d",
    "test_name": "Leaf_Thermal_Performance_Under_Load_Battery",
    "vehicle_model": "Leaf",
    "platform": "EV",
    "target_components": ["High_Voltage_Battery"],
    "estimated_duration_hours": 8.05,
    "test_type": "performance"
}
```

### Step 2: Scenario Converter

```python
# src/sim/scenario_converter.py
converter = ScenarioConverter()
sim_scenario = converter.convert_from_vta(
    vta_scenario=vta_test_scenario,
    platform=SimulationPlatform.CARLA
)
```

**Converts:**
- Vehicle model ‚Üí Vehicle configuration
- Duration ‚Üí Simulation duration
- Components ‚Üí Vehicle specs
- Test type ‚Üí Simulation parameters

### Step 3: CARLA Exporter

```python
# src/sim/carla_exporter.py
exporter = CARLAExporter()
script_path = exporter.export_python_script(sim_scenario)
```

**Generates:**
- Python script with all parameters
- Weather configuration
- Vehicle spawning code
- Simulation loop
- Data logging

### Step 4: Output File

```python
# Saved to: sim_output/carla/dfaf323f-db0f-4014-93b3-a544618c798d.py
# Ready to run!
```

---

## üéØ Key Points

### What These Files Are

1. **Executable Scripts**: Ready-to-run Python programs
2. **Test Implementations**: Convert abstract tests to concrete simulations
3. **Platform-Specific**: CARLA for 3D, SUMO for traffic
4. **Parameterized**: All test parameters embedded in code

### What They Do

1. **Connect** to simulation platform
2. **Configure** environment (weather, traffic)
3. **Spawn** vehicles with correct specifications
4. **Run** simulation for test duration
5. **Collect** vehicle state data
6. **Log** results for analysis

### Why They're Generated

1. **Automation**: No manual simulation setup needed
2. **Consistency**: Same test ‚Üí same simulation every time
3. **Reproducibility**: Can rerun exact same simulation
4. **Integration**: Directly from VTA test scenarios

---

## üìù Summary

**`sim_output/` contains:**

1. **CARLA Python Scripts** (`.py`)
   - Executable simulation programs
   - Connect to CARLA, spawn vehicles, run tests
   - Collect and log data

2. **SUMO XML Files** (`.sumocfg`, `.rou.xml`, `.vtype.xml`)
   - Traffic simulation configurations
   - Vehicle routes and types
   - Network definitions

**These files:**
- Are generated automatically from VTA test scenarios
- Are ready to run (just need CARLA/SUMO installed)
- Contain all test parameters embedded
- Can be customized for specific needs
- Enable virtual testing before physical tests

---

## üöÄ Next Steps

1. **Understand the structure** (this document)
2. **Run a simulation** (see CARLA guides)
3. **Customize if needed** (modify parameters)
4. **Collect data** (extend logging)
5. **Analyze results** (process logged data)

---

**These simulation files bridge the gap between abstract test descriptions and executable virtual tests!** üéÆüöó

